<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cards â€” Static MVP</title>
    <style>
      :root { color-scheme: dark; font-family: Inter, system-ui, Arial, sans-serif; }
      body { margin: 0; background: #0b0f1a; color: #e8ecf3; }
      .app { max-width: 1000px; margin: 0 auto; padding: 24px; }
      section { margin-top: 16px; background: #141c2d; border: 1px solid #25304a; border-radius: 12px; padding: 14px; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      input, button { border-radius: 8px; border: 1px solid #314567; background: #0d1320; color: #e8ecf3; padding: 8px 10px; }
      button { cursor: pointer; background: #233050; }
      .error { margin-top: 12px; background: #381a1a; border: 1px solid #6f2d2d; color: #ffd4d4; padding: 10px; border-radius: 8px; }
      .seat { background: #0d1320; border: 1px solid #2d3a59; border-radius: 10px; padding: 8px; margin-bottom: 8px; }
      .muted { color: #a6b0c2; }
    </style>
  </head>
  <body>
    <main class="app">
      <h1>Cards â€” Static HTML MVP</h1>
      <p class="muted">No build step. Direct GitHub Pages static app.</p>
      <div id="error" class="error" style="display:none"></div>

      <section>
        <h2>Join</h2>
        <div class="row">
          <input id="username" placeholder="username" maxlength="20" />
          <button id="joinBtn">Join</button>
          <button id="leaveBtn">Leave</button>
          <button id="refreshBtn">Refresh</button>
        </div>
        <p id="whoami" class="muted"></p>
      </section>

      <section>
        <h2>Game</h2>
        <div class="row">
          <button id="startBtn">Start New Hand</button>
          <strong id="stateLine"></strong>
        </div>
        <p><strong>Board:</strong> <span id="board"></span></p>
      </section>

      <section>
        <h2>Your Hand</h2>
        <p id="myHand">-</p>
      </section>

      <section>
        <h2>Seats</h2>
        <div id="seats"></div>
      </section>
    </main>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

      // Static public config (anon key)
      const SUPABASE_URL = 'https://oiltjegxfwjdvuzbsyfv.supabase.co'
      const SUPABASE_ANON_KEY = 'sb_publishable_7rNCoUWbz3FnDY4VdIvCbg_9R-LuirL'

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      const sessionKey = 'cards_session_id'
      let sessionId = localStorage.getItem(sessionKey)
      if (!sessionId) {
        sessionId = crypto.randomUUID()
        localStorage.setItem(sessionKey, sessionId)
      }

      const $ = (id) => document.getElementById(id)
      const showError = (msg) => {
        const el = $('error')
        el.style.display = msg ? 'block' : 'none'
        el.textContent = msg || ''
      }

      const shuffle = (arr) => {
        const a = [...arr]
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]
        }
        return a
      }

      const mkDeck = () => shuffle('23456789TJQKA'.split('').flatMap(r => 'CDHS'.split('').map(s => r+s)))

      async function refresh() {
        showError('')
        const [pRes, gRes] = await Promise.all([
          supabase.from('lobby_players').select('*').order('seat_no', { ascending: true }),
          supabase.from('game_state').select('*').eq('id', 1).single(),
        ])
        if (pRes.error) return showError(pRes.error.message)
        if (gRes.error) return showError(gRes.error.message)

        const players = pRes.data || []
        const game = gRes.data || {}
        const hand = game.hand_state || {}
        const me = players.find(p => p.session_id === sessionId)

        $('whoami').textContent = me ? `Joined as ${me.username} (seat ${me.seat_no})` : `Not joined (session ${sessionId.slice(0,8)}...)`
        $('stateLine').textContent = `Hand #${game.hand_no || 0} â€¢ Street: ${hand.street || 'waiting'} â€¢ Pot: ${hand.pot || game.pot || 0}`
        $('board').textContent = (hand.boardCards || []).join(' ') || '-'

        const myHand = hand.playersBySession?.[sessionId]?.holeCards || []
        $('myHand').textContent = myHand.length ? myHand.join(' ') : 'No cards (join + start hand)'

        $('seats').innerHTML = players
          .filter(p => p.seat_no != null)
          .sort((a,b)=>a.seat_no-b.seat_no)
          .map(p => {
            const hp = hand.playersBySession?.[p.session_id]
            const hole = p.session_id === sessionId ? (hp?.holeCards?.join(' ') || '-') : 'ðŸ‚  ðŸ‚ '
            return `<div class="seat"><strong>Seat ${p.seat_no}: ${p.username}</strong><br/>Stack: ${hp?.stack ?? p.stack} â€¢ Hole: ${hole} â€¢ Last: ${hp?.lastAction || '-'}</div>`
          }).join('')
      }

      async function join() {
        const username = $('username').value.trim()
        if (!username) return showError('Username required')
        const { data } = await supabase.from('lobby_players').select('seat_no')
        const used = new Set((data||[]).map(p=>p.seat_no).filter(Boolean))
        let seat = null
        for (let i=1;i<=8;i++) if (!used.has(i)) { seat = i; break }
        if (!seat) return showError('Lobby full')

        const { error } = await supabase.from('lobby_players').upsert({
          session_id: sessionId,
          username,
          seat_no: seat,
          heartbeat_at: new Date().toISOString(),
        }, { onConflict: 'session_id' })
        if (error) return showError(error.message)
        refresh()
      }

      async function leave() {
        await supabase.from('lobby_players').delete().eq('session_id', sessionId)
        refresh()
      }

      async function startHand() {
        const { data: players } = await supabase.from('lobby_players').select('*').order('seat_no', { ascending: true })
        const seated = (players || []).filter(p => p.seat_no != null)
        if (seated.length < 2) return showError('Need at least 2 players')

        const deck = mkDeck()
        const playersBySession = {}
        for (const p of seated) {
          playersBySession[p.session_id] = {
            session_id: p.session_id,
            username: p.username,
            seat_no: p.seat_no,
            stack: p.stack,
            holeCards: [deck.pop(), deck.pop()],
            lastAction: 'dealt',
          }
        }

        const hand_state = {
          street: 'preflop',
          boardCards: [],
          deck,
          pot: 0,
          playersBySession,
          actionLog: ['hand started'],
        }

        const { data: g } = await supabase.from('game_state').select('hand_no').eq('id',1).single()
        const hand_no = (g?.hand_no || 0) + 1
        const { error } = await supabase.from('game_state').update({ hand_no, phase: 'preflop', hand_state, updated_at: new Date().toISOString() }).eq('id', 1)
        if (error) return showError(error.message)
        refresh()
      }

      $('joinBtn').onclick = join
      $('leaveBtn').onclick = leave
      $('refreshBtn').onclick = refresh
      $('startBtn').onclick = startHand

      const channel = supabase
        .channel('cards-static-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'lobby_players' }, refresh)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'game_state' }, refresh)
        .subscribe()

      refresh()
      setInterval(async () => {
        await supabase.from('lobby_players').update({ heartbeat_at: new Date().toISOString() }).eq('session_id', sessionId)
      }, 15000)
      window.addEventListener('beforeunload', () => supabase.removeChannel(channel))
    </script>
  </body>
</html>
